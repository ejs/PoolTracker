<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Hello Wave" height="35">
    <Require feature="wave" /> 
  </ModulePrefs>
  <Content type="html">
    <![CDATA[     
       <style type="text/css">
          #content.edit #view {display : none; }
          ul { padding: 0; font-size: 0.8em;}
          li { display: inline; height: 1em; float: left;  width : 1em; margin: 0 0.1em; -moz-border-radius: 1em; -webkit-border-radius: 1em;}
          li.unavalable { display:none; }
          li.clear, li.full, li.empty { cursor: pointer; }
          li.full { background-color: #000; }
          li.empty { background-color: #BBB; }
          li.breaker { width: .5em; }
          #content.view #edit {display: none; }
          form { display: inline; font-size: .8em;}
      </style>
      <script type="text/javascript">
            function set_pool(item) {
                if (item.className != 'unavalable' ) {
                    var element = item.parentNode;
                    var count = 0;
                    for (var i in element.childNodes) {
                        var node = element.childNodes[i];
                        if (node.className == 'full' || node.className == 'empty')
                            count += 1;
                        if (node == item)
                            break;
                    }
                    wave.getState().submitValue('pool', count);
                }
            }

            function set_cap() {
                wave.getState().submitValue('cap', document.getElementById("selector").selectedIndex);
            }
            
            function updateAll() {
                var state = wave.getState();
                var available = parseInt(state.get('cap', 10));
                var active = parseInt(state.get('pool', 0));

                update_pool(available, active);
                update_selector(available);
            }

            function update_pool(available, active) {
                var element = document.getElementById("pool");
                var count = 0;
                for (var i in element.childNodes) {
                    var node = element.childNodes[i];
                    if (node.className == 'full' || node.className == 'empty' || node.className == 'unavalable') {
                        if ( count >= available )
                            node.className = 'unavalable'; 
                        else
                            node.className = (count < active) ? 'full' : 'empty'; 
                        count += 1;
                    }
                }
                for (var i = count; i < available ; i ++) {
                    var newli = document.createElement('li');
                    newli.onclick = function() { set_pool(this);}
                    newli.className = (i < active) ? 'full' : 'empty';
                    element.appendChild(newli);
                    if (i%5 == 4){
                        var newdevider = document.createElement('li');
                        newdevider.className="breaker";
                        element.appendChild(newdevider);
                    }
                }
            }

            function update_selector(available) {
                var selector = document.getElementById("selector");
                var count = 0;
                for( var i in selector.childNodes) {
                    if (selector.childNodes[i].tagName == "OPTION") {
                        selector.childNodes[i].style.display = (count <= (available + 5)) ? "" : "none";
                        count += 1;
                    }
                }
                for (var i = count; i <= available+5 ; i ++) {
                    var newoption = document.createElement('option');
                    newoption.textContent = i;
                    newoption.value = i;
                    selector.appendChild(newoption);
                }
                selector.selectedIndex = available;
            }

            function updateMode(mode) {
                document.getElementById('content').className = (mode == wave.Mode.EDIT ? 'edit' : 'view');
                set_cap();
            }
            
            gadgets.util.registerOnLoadHandler(function() {
                wave.setStateCallback(updateAll);
                wave.setModeCallback(updateMode);
            });
      </script>
      <div id="content">
        <div id="view">
          <ul class="pool" id="pool">
            <li class="clear" onClick="set_pool(this);">X</li>
          </ul>
        </div>
        <form id="edit">
          <label>Max Value</label>
          <select name="maxvalue" id="selector" onClick="set_cap(this);">
            <option value="0">0</option>
          </select>
        </form>
      </div>
    ]]>
  </Content>
</Module>
